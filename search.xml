<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>AWS 文档海外区和中国区切换</title>
      <link href="/2023/10/13/basic/aws-link/"/>
      <url>/2023/10/13/basic/aws-link/</url>
      
        <content type="html"><![CDATA[<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// ==UserScript==</span><span class="token comment" spellcheck="true">// @name         New Userscript1</span><span class="token comment" spellcheck="true">// @namespace    http://tampermonkey.net/</span><span class="token comment" spellcheck="true">// @version      0.1</span><span class="token comment" spellcheck="true">// @description  try to take over the world!</span><span class="token comment" spellcheck="true">// @author       You</span><span class="token comment" spellcheck="true">// @match        https://docs.amazonaws.cn/*</span><span class="token comment" spellcheck="true">// @match        https://docs.aws.amazon.com/*</span><span class="token comment" spellcheck="true">// @icon         data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==</span><span class="token comment" spellcheck="true">// @grant        none</span><span class="token comment" spellcheck="true">// ==/UserScript==</span><span class="token comment" spellcheck="true">//var button=''</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token string">'use strict'</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Create the window element</span>    <span class="token keyword">var</span> windowDiv <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    windowDiv<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">"Click Me"</span><span class="token punctuation">;</span>    windowDiv<span class="token punctuation">.</span>style<span class="token punctuation">.</span>position <span class="token operator">=</span> <span class="token string">"fixed"</span><span class="token punctuation">;</span>    windowDiv<span class="token punctuation">.</span>style<span class="token punctuation">.</span>bottom <span class="token operator">=</span> <span class="token string">"20px"</span><span class="token punctuation">;</span>    windowDiv<span class="token punctuation">.</span>style<span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token string">"400px"</span><span class="token punctuation">;</span>    windowDiv<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token string">"81px"</span><span class="token punctuation">;</span>    windowDiv<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token string">"50px"</span><span class="token punctuation">;</span>    windowDiv<span class="token punctuation">.</span>style<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> <span class="token string">"#fff"</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//windowDiv.style.border = "0px solid #000";</span>    windowDiv<span class="token punctuation">.</span>style<span class="token punctuation">.</span>cursor <span class="token operator">=</span> <span class="token string">"move"</span><span class="token punctuation">;</span>    windowDiv<span class="token punctuation">.</span>style<span class="token punctuation">.</span>zIndex <span class="token operator">=</span> <span class="token string">"9999"</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Add the window to the body</span>    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>windowDiv<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Add a click event listener to the button</span>    <span class="token keyword">var</span> button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"myButton"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    button<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token string">"81px"</span><span class="token punctuation">;</span>    button<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token string">"50px"</span><span class="token punctuation">;</span>    button<span class="token punctuation">.</span>style<span class="token punctuation">.</span>padding <span class="token operator">=</span> <span class="token string">"5px"</span>    button<span class="token punctuation">.</span>style<span class="token punctuation">.</span>fontWeight <span class="token operator">=</span> <span class="token string">"bold"</span><span class="token punctuation">;</span>    button<span class="token punctuation">.</span>style<span class="token punctuation">.</span>background <span class="token operator">=</span> <span class="token string">"linear-gradient(to right, #4db6ac, #4caf50, #fbc02d, #ef5350)"</span><span class="token punctuation">;</span>    button<span class="token punctuation">.</span>style<span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token string">"white"</span><span class="token punctuation">;</span>    button<span class="token punctuation">.</span>style<span class="token punctuation">.</span>padding <span class="token operator">=</span> <span class="token string">"10px 20px"</span><span class="token punctuation">;</span>    button<span class="token punctuation">.</span>style<span class="token punctuation">.</span>border <span class="token operator">=</span> <span class="token string">"none"</span><span class="token punctuation">;</span>    button<span class="token punctuation">.</span>style<span class="token punctuation">.</span>borderRadius <span class="token operator">=</span> <span class="token string">"5px"</span><span class="token punctuation">;</span>    button<span class="token punctuation">.</span>addEventListener <span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token function">link_convert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">button_display</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Add a mousedown event listener to the window</span>    <span class="token keyword">var</span> isDragging <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> dragStartX<span class="token punctuation">,</span> dragStartY<span class="token punctuation">,</span> offsetX<span class="token punctuation">,</span> offsetY<span class="token punctuation">;</span>    windowDiv<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"mousedown"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        isDragging <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        dragStartX <span class="token operator">=</span> event<span class="token punctuation">.</span>clientX<span class="token punctuation">;</span>        dragStartY <span class="token operator">=</span> event<span class="token punctuation">.</span>clientY<span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Add a mousemove event listener to the document</span>    document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"mousemove"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>isDragging<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token keyword">var</span> deltaX <span class="token operator">=</span> event<span class="token punctuation">.</span>clientX <span class="token operator">-</span> dragStartX<span class="token punctuation">;</span>            <span class="token keyword">var</span> deltaY <span class="token operator">=</span> event<span class="token punctuation">.</span>clientY <span class="token operator">-</span> dragStartY<span class="token punctuation">;</span>            windowDiv<span class="token punctuation">.</span>style<span class="token punctuation">.</span>left <span class="token operator">=</span> dragStartX <span class="token operator">+</span> deltaX <span class="token operator">+</span> <span class="token string">"px"</span><span class="token punctuation">;</span>            windowDiv<span class="token punctuation">.</span>style<span class="token punctuation">.</span>top <span class="token operator">=</span> dragStartY <span class="token operator">+</span> deltaY <span class="token operator">+</span> <span class="token string">"px"</span><span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Add a mouseup event listener to the document</span>    document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"mouseup"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        isDragging <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">link_convert</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> aws_global_link <span class="token operator">=</span> <span class="token string">"aws.amazon.com"</span>        <span class="token keyword">let</span> aws_china_link <span class="token operator">=</span> <span class="token string">"amazonaws.cn"</span>        <span class="token keyword">let</span> url <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href        <span class="token keyword">let</span> newlink <span class="token operator">=</span> url        <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>aws_global_link<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            newlink <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>aws_global_link<span class="token punctuation">,</span> aws_china_link<span class="token punctuation">)</span>            window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> newlink<span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>aws_china_link<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            newlink <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>aws_china_link<span class="token punctuation">,</span> aws_global_link<span class="token punctuation">)</span>            window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> newlink<span class="token punctuation">;</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">button_display</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> aws_global_link <span class="token operator">=</span> <span class="token string">"aws.amazon.com"</span>        <span class="token keyword">let</span> aws_china_link <span class="token operator">=</span> <span class="token string">"amazonaws.cn"</span>        <span class="token keyword">let</span> url <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href        <span class="token keyword">let</span> newlink <span class="token operator">=</span> url        <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>aws_global_link<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            button<span class="token punctuation">.</span>innerHTML<span class="token operator">=</span><span class="token string">"中"</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>aws_china_link<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>            button<span class="token punctuation">.</span>innerHTML<span class="token operator">=</span><span class="token string">"Eng"</span>        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> doc </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Javascript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>域名那些事</title>
      <link href="/2023/10/13/basic/yu-ming/"/>
      <url>/2023/10/13/basic/yu-ming/</url>
      
        <content type="html"><![CDATA[<h2 id="先谈备案"><a href="#先谈备案" class="headerlink" title="先谈备案"></a>先谈备案</h2><p>每一个网站都需要有一个域名，起初是为了方便记忆。<br>但是在国内而言还有一个特殊的身份，那么就是备案。</p><p>有人说域名备案的本质是服务器备案，对于阿里的云来说，在填写备案的信息的时候还要指定一个ECS，而且把域名指向这个服务器，否则就会收到工信部的发送的短信，意思是域名实际指向和备案信息不符，然后把备案给取消掉。我曾经把域名指向了git page，然后就收到了工信部的短信。</p><p>关于备案这个事，本人不完全测试，只要域名和服务器有一个是国内的资源那么就会发生这个事情。</p><ul><li>阿里域名指向 git page （被工信部取消备案）</li><li>海外域名指向开了80端口的EC2 （光环新网提示您备案）</li></ul><h2 id="域名"><a href="#域名" class="headerlink" title="域名"></a>域名</h2><p>各大云服务商都可以购买域名，比如阿里云，腾讯云，aws海外。</p><p>以下是几个常用的记录：</p><ul><li>A ： IPV4</li><li>AAAA： IPV6</li><li>CNAME：域名别名</li><li>SOA：SOA记录用于在众多NS记录中那一台是主服务器</li><li>NS：DNS服务器，最少两个防止单点故障</li></ul><p>对于阿里云来说，还可以指定@记录来表示根域名。</p><p>域名的迁移也非常简单，以阿里域名迁移到aws为例，</p><ul><li>阿里云购买域名</li><li>在阿里点击域名迁移(有六个DNS地址)</li><li>解析迁移到R53（把阿里的解析的六个dns写到R53的NS记录，至少填写两个地址）</li></ul><h2 id="证书"><a href="#证书" class="headerlink" title="证书"></a>证书</h2><p>证书是为了验证，所以又一定的CA机构颁发。</p><p>对于企业而言，在一些CA网站申请的证书流程繁琐，费用也不菲。所以AWS的ACM服务恰好让这个问题变得简单操作。</p><ul><li>不能导出证书</li><li>不能生成私有证书（需要自签）</li><li>不能绑定EC2</li></ul><p><a href="https://skyao.io/learning-dns/dns/record/soa.html">SOA记录 - DNS学习笔记</a></p>]]></content>
      
      
      <categories>
          
          <category> route53 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 域名 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>codecommit 单个文件的限制</title>
      <link href="/2023/10/13/code-family/codecommit-xian-zhi/"/>
      <url>/2023/10/13/code-family/codecommit-xian-zhi/</url>
      
        <content type="html"><![CDATA[<p>Q: 能否提升codecommit关于单个文件的2G大小限制。<br>A: 关于2G的硬限制目前没有办法做更改，另外测试了git lfs 提交大文件，仍然无法push到codecommit。</p>]]></content>
      
      
      <categories>
          
          <category> codecommit </category>
          
      </categories>
      
      
        <tags>
            
            <tag> git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IAM 限制</title>
      <link href="/2023/10/13/authority/iam/iam-xian-zhi/"/>
      <url>/2023/10/13/authority/iam/iam-xian-zhi/</url>
      
        <content type="html"><![CDATA[<h3 id="基于源-IP-拒绝对Amazon-的访问-1"><a href="#基于源-IP-拒绝对Amazon-的访问-1" class="headerlink" title="基于源 IP 拒绝对Amazon 的访问[^1]"></a>基于源 IP 拒绝对Amazon 的访问[^1]</h3><p>在相应的用户中附件如下策略：</p><ol><li>SourceIp 填写您允许的特定IP白名单。</li><li>策略不拒绝 Amazon 服务使用主体的凭证发出的请求,  也就是说可以正常配置aws configure。</li><li>但是从 IP 白名单之外发出请求时（比如aws s3 ls），请求将被拒绝。</li></ol><pre class="line-numbers language-json"><code class="language-json">&amp;#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>    <span class="token property">"Statement"</span><span class="token operator">:</span> &amp;#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Deny"</span><span class="token punctuation">,</span>        <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>        <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>        <span class="token property">"Condition"</span><span class="token operator">:</span> &amp;#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token property">"NotIpAddress"</span><span class="token operator">:</span> &amp;#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token property">"aws:SourceIp"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                    <span class="token string">"192.0.2.0/24"</span><span class="token punctuation">,</span>                    <span class="token string">"203.0.113.0/24"</span>                <span class="token punctuation">]</span>            &amp;#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span>            <span class="token property">"Bool"</span><span class="token operator">:</span> &amp;#<span class="token number">123</span><span class="token punctuation">;</span><span class="token property">"aws:ViaAWSService"</span><span class="token operator">:</span> <span class="token string">"false"</span>&amp;#<span class="token number">125</span><span class="token punctuation">;</span>        &amp;#<span class="token number">125</span><span class="token punctuation">;</span>    &amp;#<span class="token number">125</span><span class="token punctuation">;</span>&amp;#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>[^1]: <a href="https://docs.amazonaws.cn/IAM/latest/UserGuide/reference_policies_examples_aws_deny-ip.html">Amazon：基于源 IP 拒绝对 Amazon 的访问 - Amazon Identity and Access Management</a></p>]]></content>
      
      
      <categories>
          
          <category> iam </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iam policy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IAM 常用命令</title>
      <link href="/2023/10/13/authority/iam/iam-chang-yong-ming-ling/"/>
      <url>/2023/10/13/authority/iam/iam-chang-yong-ming-ling/</url>
      
        <content type="html"><![CDATA[<p>IAM常用命令:</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 查看身份</span>aws sts get-caller-identity<span class="token comment" spellcheck="true"># 过滤策略</span>policyArn<span class="token operator">=</span><span class="token punctuation">$(</span>aws iam list-policies --output text --query <span class="token string">'Policies[?PolicyName == <span class="token variable"><span class="token variable">`</span>S3-Delete-Bucket-Policy<span class="token variable">`</span></span>].Arn'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># 查看策略</span>aws iam get-policy-version --policy-arn <span class="token variable">$policyArn</span> --version-id v1<span class="token comment" spellcheck="true"># 给role绑定策略</span>aws iam attach-role-policy --policy-arn <span class="token variable">$policyArn</span> --role-name notes-application-role<span class="token comment" spellcheck="true"># 查看role的策略</span>aws iam list-attached-role-policies --role-name notes-application-role<span class="token comment" spellcheck="true"># 给iam绑定策略</span>aws iam attach-role-policy --policy-arn <span class="token variable">$policyArn</span> --user-name notes-application-role<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> iam </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iam policy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mfa 失效</title>
      <link href="/2023/10/13/authority/iam/mfa/"/>
      <url>/2023/10/13/authority/iam/mfa/</url>
      
        <content type="html"><![CDATA[<p>经常会遇到mfa失效的时候，<br>尝试同步mfa</p><pre class="line-numbers language-bash"><code class="language-bash">aws iam resync-mfa-device --user-name kail --serial-number arn:aws-cn:iam::208892152133:mfa/kail --authentication-code1 653006 --authentication-code2 742895<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果同步mfa无效，那么使用CLI删除重新绑定</p><pre class="line-numbers language-bash"><code class="language-bash">aws iam deactivate-mfa-device --user-name kail --serial-number arn:aws-cn:iam::208892152133:mfa/kail<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> iam </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mfa </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Flask部署机器学习模型</title>
      <link href="/2023/10/13/dev/basic/flask/"/>
      <url>/2023/10/13/dev/basic/flask/</url>
      
        <content type="html"><![CDATA[<p>部署机器学习模型使用 Flask 是一个常见的实践，尤其是为了创建一个简单的API。以下是一个简化的步骤来部署一个机器学习模型：</p><p>模型训练:<br>首先，你需要有一个已经训练好的机器学习模型。为了简化，我们可以使用一个简单的模型，例如使用 sklearn 训练的模型。</p><p>Flask 应用:<br>创建一个 Flask 应用，并通过 Flask 的路由定义API端点来获取预测。</p><p>模型预测:<br>当API被调用时，加载模型并返回预测。</p><p>以下是一个简单的例子，使用 Flask 部署一个预先训练的模型：</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> jsonify<span class="token keyword">import</span> joblibapp <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span><span class="token comment" spellcheck="true"># 加载预先训练好的模型</span>model <span class="token operator">=</span> joblib<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'path_to_your_model.pkl'</span><span class="token punctuation">)</span>@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/predict'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># 获取请求的数据</span>    data <span class="token operator">=</span> request<span class="token punctuation">.</span>get_json<span class="token punctuation">(</span>force<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 模型预测</span>    prediction <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span><span class="token punctuation">[</span>data<span class="token punctuation">[</span><span class="token string">'features'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 将预测结果转换为JSON格式并返回</span>    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span>prediction<span class="token operator">=</span>prediction<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>port<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>进一步部署:</p><p>为了生产环境，你可能想使用像 Gunicorn 这样的WSGI服务器来运行 Flask 应用，而不是直接使用 Flask 的开发服务器。<br>你可以考虑使用容器化技术，如 Docker，来确保应用和所有其依赖关系都在一个独立的环境中运行。<br>为了可伸缩性和高可用性，考虑部署到像 AWS Elastic Beanstalk、Google Cloud Run、Azure Web Apps for Containers 这样的云平台上。<br>安全性:<br>确保API是安全的。考虑使用 API 密钥、OAuth 或其他认证机制来限制谁可以访问你的API。</p><p>最后，请记住定期更新和维护你的模型和应用，确保它们的安全性和准确性。</p>]]></content>
      
      
      <categories>
          
          <category> dev </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Flask </tag>
            
            <tag> Machine learning </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginx返回客户端IP</title>
      <link href="/2023/10/13/dev/basic/nginx/"/>
      <url>/2023/10/13/dev/basic/nginx/</url>
      
        <content type="html"><![CDATA[<ol><li>在此文件中输入以下内容：</li></ol><pre class="line-numbers language-conf"><code class="language-conf">server &#123;    listen 800 default_server;    listen [::]:800 default_server;    root /var/www/html;    index index.html index.htm index.nginx-debian.html;    server_name _;    location / &#123;        try_files $uri $uri/ =404;    &#125;    location /myip &#123;        default_type text/plain;        return 200 $remote_addr;    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>检查Nginx配置是否有误：</li></ol><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">sudo</span> nginx -t<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果返回<code>syntax is okay</code>和<code>test is successful</code>，则配置没有问题。</p><ol start="3"><li>重启Nginx以应用更改：</li></ol><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">sudo</span> systemctl restart nginx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>现在，当您访问<code>http://your_server_ip_or_domain/myip</code>时，它应该显示您的公网IP地址。</p>]]></content>
      
      
      <categories>
          
          <category> dev </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nginx </tag>
            
            <tag> Public IP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>boto3给HTTP签名</title>
      <link href="/2023/10/13/dev/basic/signv4/"/>
      <url>/2023/10/13/dev/basic/signv4/</url>
      
        <content type="html"><![CDATA[<h2 id="为什么要签名"><a href="#为什么要签名" class="headerlink" title="为什么要签名"></a>为什么要签名</h2><p>通常来说HTTP请求是没有办法携带IAM身份凭证的，日常的请求通过AWS SDK已经足够，但是仍然有些服务暴露出来的是REST API，用API的话只是提供一个接口，无关内部实现和具体语言调用。只要你的程序支持web，就可以使用这个REST API。</p><p>下边这个例子我们用到三个库，<strong>boto3</strong>，<strong>requests</strong>，<strong>requests_aws4auth</strong></p><pre class="line-numbers language-python"><code class="language-python">iimport boto3<span class="token keyword">import</span> requests  <span class="token keyword">from</span> requests_aws4auth <span class="token keyword">import</span> AWS4Auth  Url <span class="token operator">=</span> <span class="token string">'requesturl'</span>region <span class="token operator">=</span> <span class="token string">'cn-north-1'</span>service <span class="token operator">=</span> <span class="token string">'s3'</span>credentials <span class="token operator">=</span> boto3<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_credentials<span class="token punctuation">(</span><span class="token punctuation">)</span>awsauth <span class="token operator">=</span> AWS4Auth<span class="token punctuation">(</span>credentials<span class="token punctuation">.</span>access_key<span class="token punctuation">,</span> credentials<span class="token punctuation">.</span>secret_key<span class="token punctuation">,</span> region<span class="token punctuation">,</span> service<span class="token punctuation">)</span>request <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>Url<span class="token punctuation">,</span>auth<span class="token operator">=</span>AWS4Auth<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>官方其实提提供了两种办法，如下：</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 1. 用普通参数传入，这里用位置参数会报错。</span><span class="token keyword">import</span> requests<span class="token keyword">from</span> requests_aws4auth <span class="token keyword">import</span> AWS4Authauth <span class="token operator">=</span> AWS4Auth<span class="token punctuation">(</span><span class="token string">'&lt;ACCESS ID>'</span><span class="token punctuation">,</span> <span class="token string">'&lt;ACCESS KEY>'</span><span class="token punctuation">,</span> <span class="token string">'eu-west-1'</span><span class="token punctuation">,</span> <span class="token string">'s3'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># 2.使用STS身份，都是位置参数</span><span class="token keyword">from</span> requests_aws4auth <span class="token keyword">import</span> AWS4Auth<span class="token keyword">from</span> botocore<span class="token punctuation">.</span>session <span class="token keyword">import</span> Sessioncredentials <span class="token operator">=</span> Session<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_credentials<span class="token punctuation">(</span><span class="token punctuation">)</span>auth <span class="token operator">=</span> AWS4Auth<span class="token punctuation">(</span>region<span class="token operator">=</span><span class="token string">'eu-west-1'</span><span class="token punctuation">,</span> service<span class="token operator">=</span><span class="token string">'es'</span><span class="token punctuation">,</span>refreshable_credentials<span class="token operator">=</span>credentials<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>AWS4Auth这个类的构造器是这样的，我们看一下源码。<br>入口处两个参数 *args，**kwargs,  关于这两参数，前者代表传入数组，后者代表传入字典，更多内容在geeksforgeeks有说明[^args]。这里有个坑，就是构造器限制数组的长度只能是0，2，4，5，如果检测到其他直接会报错type error。如果把给数组的参数给字典，也就是把位置参数写成关键字参数会报错，源码没有就这点进行说明。</p><ol><li><strong>if self.refreshable_credentials</strong> 检测是不是使用的STS身份，如果是就按照名字取字典的数值。</li><li><strong>else if l not in [2, 4, 5]:</strong> 这里检测数组的长度<ol><li>如果是len &#x3D;&#x3D; 2， 那么参数是access_id，AWS4SigningKey，其中AWS4SigningKey又是根据secret_key, region, service，和时间制作的sign_sha256算法的签名。</li><li>如果不是那么那么需要使用secret_key, region, service，和时间重新签名。</li></ol></li></ol><p>签名算法如下</p><pre class="line-numbers language-python"><code class="language-python">init_key <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'AWS4'</span> <span class="token operator">+</span> secret_key<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>  date_key <span class="token operator">=</span> cls<span class="token punctuation">.</span>sign_sha256<span class="token punctuation">(</span>init_key<span class="token punctuation">,</span> date<span class="token punctuation">)</span>  region_key <span class="token operator">=</span> cls<span class="token punctuation">.</span>sign_sha256<span class="token punctuation">(</span>date_key<span class="token punctuation">,</span> region<span class="token punctuation">)</span>  service_key <span class="token operator">=</span> cls<span class="token punctuation">.</span>sign_sha256<span class="token punctuation">(</span>region_key<span class="token punctuation">,</span> service<span class="token punctuation">)</span>  key <span class="token operator">=</span> cls<span class="token punctuation">.</span>sign_sha256<span class="token punctuation">(</span>service_key<span class="token punctuation">,</span> <span class="token string">'aws4_request'</span><span class="token punctuation">)</span>  <span class="token keyword">if</span> intermediates<span class="token punctuation">:</span>      <span class="token keyword">return</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> date_key<span class="token punctuation">,</span> region_key<span class="token punctuation">,</span> service_key<span class="token punctuation">)</span>  <span class="token keyword">else</span><span class="token punctuation">:</span>      <span class="token keyword">return</span> key<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>[^args]: <a href="https://www.geeksforgeeks.org/args-kwargs-python/">*args and **kwargs in Python - GeeksforGeeks</a></p><p><img src="/asserts/Pasted%20image%2020220925164746.png"></p><pre class="line-numbers language-python"><code class="language-python">AWS4Auth<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>self<span class="token punctuation">.</span>signing_key <span class="token operator">=</span> None  self<span class="token punctuation">.</span>refreshable_credentials <span class="token operator">=</span> kwargs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'refreshable_credentials'</span><span class="token punctuation">,</span> None<span class="token punctuation">)</span>  <span class="token keyword">if</span> self<span class="token punctuation">.</span>refreshable_credentials<span class="token punctuation">:</span>      <span class="token comment" spellcheck="true"># instantiate from refreshable_credentials  </span>    self<span class="token punctuation">.</span>service <span class="token operator">=</span> kwargs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'service'</span><span class="token punctuation">,</span> None<span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token operator">not</span> self<span class="token punctuation">.</span>service<span class="token punctuation">:</span>          <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string">'service must be provided as keyword argument when using refreshable_credentials'</span><span class="token punctuation">)</span>      self<span class="token punctuation">.</span>region <span class="token operator">=</span> kwargs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'region'</span><span class="token punctuation">,</span> None<span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token operator">not</span> self<span class="token punctuation">.</span>region<span class="token punctuation">:</span>          <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string">'region must be provided as keyword argument when using refreshable_credentials'</span><span class="token punctuation">)</span>      self<span class="token punctuation">.</span>date <span class="token operator">=</span> kwargs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">,</span> None<span class="token punctuation">)</span>      self<span class="token punctuation">.</span>default_include_headers<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">'x-amz-security-token'</span><span class="token punctuation">)</span>  <span class="token keyword">else</span><span class="token punctuation">:</span>      l <span class="token operator">=</span> len<span class="token punctuation">(</span>args<span class="token punctuation">)</span>      <span class="token keyword">if</span> l <span class="token operator">not</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">:</span>          msg <span class="token operator">=</span> <span class="token string">'AWS4Auth() takes 2, 4 or 5 arguments, &amp;#123;&amp;#125; given'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>l<span class="token punctuation">)</span>          <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>      self<span class="token punctuation">.</span>access_id <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>      <span class="token keyword">if</span> isinstance<span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> AWS4SigningKey<span class="token punctuation">)</span> <span class="token operator">and</span> l <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>          <span class="token comment" spellcheck="true"># instantiate from signing key  </span>        self<span class="token punctuation">.</span>signing_key <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>          self<span class="token punctuation">.</span>region <span class="token operator">=</span> self<span class="token punctuation">.</span>signing_key<span class="token punctuation">.</span>region          self<span class="token punctuation">.</span>service <span class="token operator">=</span> self<span class="token punctuation">.</span>signing_key<span class="token punctuation">.</span>service          self<span class="token punctuation">.</span>date <span class="token operator">=</span> self<span class="token punctuation">.</span>signing_key<span class="token punctuation">.</span>date      <span class="token keyword">elif</span> l <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">:</span>          <span class="token comment" spellcheck="true"># instantiate from args  </span>        secret_key <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>          self<span class="token punctuation">.</span>region <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>          self<span class="token punctuation">.</span>service <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>          self<span class="token punctuation">.</span>date <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token keyword">if</span> l <span class="token operator">==</span> <span class="token number">5</span> <span class="token keyword">else</span> None          self<span class="token punctuation">.</span>regenerate_signing_key<span class="token punctuation">(</span>secret_key<span class="token operator">=</span>secret_key<span class="token punctuation">)</span>      <span class="token keyword">else</span><span class="token punctuation">:</span>          <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>session_token <span class="token operator">=</span> kwargs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'session_token'</span><span class="token punctuation">)</span>      <span class="token keyword">if</span> self<span class="token punctuation">.</span>session_token<span class="token punctuation">:</span>          self<span class="token punctuation">.</span>default_include_headers<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">'x-amz-security-token'</span><span class="token punctuation">)</span>    raise_invalid_date <span class="token operator">=</span> kwargs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'raise_invalid_date'</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>  <span class="token keyword">if</span> raise_invalid_date <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">:</span>      self<span class="token punctuation">.</span>raise_invalid_date <span class="token operator">=</span> raise_invalid_date  <span class="token keyword">else</span><span class="token punctuation">:</span>      <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">'raise_invalid_date must be True or False in AWS4Auth.__init__()'</span><span class="token punctuation">)</span>    self<span class="token punctuation">.</span>include_hdrs <span class="token operator">=</span> set<span class="token punctuation">(</span>self<span class="token punctuation">.</span>default_include_headers<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># if the key exists and it's some sort of listable object, use it.  </span><span class="token keyword">if</span> <span class="token string">'include_hdrs'</span> <span class="token keyword">in</span> kwargs <span class="token operator">and</span> isinstance<span class="token punctuation">(</span>kwargs<span class="token punctuation">[</span><span class="token string">'include_hdrs'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> abc<span class="token punctuation">.</span>Iterable<span class="token punctuation">)</span><span class="token punctuation">:</span>      self<span class="token punctuation">.</span>include_hdrs <span class="token operator">=</span> set<span class="token punctuation">(</span>kwargs<span class="token punctuation">[</span><span class="token string">'include_hdrs'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    AuthBase<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>help(AWS4Auth)</strong>  之后：</p><pre class="line-numbers language-python"><code class="language-python">Help on <span class="token keyword">class</span> <span class="token class-name">AWS4Auth</span> <span class="token keyword">in</span> module requests_aws4auth<span class="token punctuation">.</span>aws4auth<span class="token punctuation">:</span><span class="token keyword">class</span> <span class="token class-name">AWS4Auth</span><span class="token punctuation">(</span>requests<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>AuthBase<span class="token punctuation">)</span> <span class="token operator">|</span>  AWS4Auth<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span> <span class="token operator">|</span>   <span class="token operator">|</span>  Requests authentication <span class="token keyword">class</span> <span class="token class-name">providing</span> AWS version <span class="token number">4</span> authentication <span class="token keyword">for</span> <span class="token operator">|</span>  HTTP requests<span class="token punctuation">.</span> Implements header<span class="token operator">-</span>based authentication only<span class="token punctuation">,</span> GET URL <span class="token operator">|</span>  parameter <span class="token operator">and</span> POST parameter authentication are <span class="token operator">not</span> supported<span class="token punctuation">.</span> <span class="token operator">|</span>   <span class="token operator">|</span>  Provides authentication <span class="token keyword">for</span> regions <span class="token operator">and</span> services listed at<span class="token punctuation">:</span> <span class="token operator">|</span>  http<span class="token punctuation">:</span><span class="token operator">//</span>docs<span class="token punctuation">.</span>aws<span class="token punctuation">.</span>amazon<span class="token punctuation">.</span>com<span class="token operator">/</span>general<span class="token operator">/</span>latest<span class="token operator">/</span>gr<span class="token operator">/</span>rande<span class="token punctuation">.</span>html <span class="token operator">|</span>   <span class="token operator">|</span>  The following services do <span class="token operator">not</span> support AWS auth version <span class="token number">4</span> <span class="token operator">and</span> are <span class="token operator">not</span> usable <span class="token operator">|</span>  <span class="token keyword">with</span> this package<span class="token punctuation">:</span> <span class="token operator">|</span>      <span class="token operator">*</span> Simple Email Service <span class="token punctuation">(</span>SES<span class="token punctuation">)</span>' <span class="token operator">-</span> AWS auth v3 only <span class="token operator">|</span>      <span class="token operator">*</span> Simple Workflow Service <span class="token operator">-</span> AWS auth v3 only <span class="token operator">|</span>      <span class="token operator">*</span> Import<span class="token operator">/</span>Export <span class="token operator">-</span> AWS auth v2 only <span class="token operator">|</span>      <span class="token operator">*</span> SimpleDB <span class="token operator">-</span> AWS auth V2 only <span class="token operator">|</span>      <span class="token operator">*</span> DevPay <span class="token operator">-</span> AWS auth v1 only <span class="token operator">|</span>      <span class="token operator">*</span> Mechanical Turk <span class="token operator">-</span> has own signing mechanism <span class="token operator">|</span>   <span class="token operator">|</span>  You can reuse AWS4Auth instances to sign <span class="token keyword">as</span> many requests <span class="token keyword">as</span> you need<span class="token punctuation">.</span> <span class="token operator">|</span>   <span class="token operator">|</span>  Basic usage <span class="token operator">|</span>  <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token operator">|</span>  <span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> requests <span class="token operator">|</span>  <span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> requests_aws4auth <span class="token keyword">import</span> AWS4Auth <span class="token operator">|</span>  <span class="token operator">>></span><span class="token operator">></span> auth <span class="token operator">=</span> AWS4Auth<span class="token punctuation">(</span><span class="token string">'&lt;ACCESS ID>'</span><span class="token punctuation">,</span> <span class="token string">'&lt;ACCESS KEY>'</span><span class="token punctuation">,</span> <span class="token string">'eu-west-1'</span><span class="token punctuation">,</span> <span class="token string">'s3'</span><span class="token punctuation">)</span> <span class="token operator">|</span>  <span class="token operator">>></span><span class="token operator">></span> endpoint <span class="token operator">=</span> <span class="token string">'http://s3-eu-west-1.amazonaws.com'</span> <span class="token operator">|</span>  <span class="token operator">>></span><span class="token operator">></span> response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>endpoint<span class="token punctuation">,</span> auth<span class="token operator">=</span>auth<span class="token punctuation">)</span> <span class="token operator">|</span>  <span class="token operator">>></span><span class="token operator">></span> response<span class="token punctuation">.</span>text <span class="token operator">|</span>  <span class="token operator">&lt;</span>?xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span>?<span class="token operator">></span> <span class="token operator">|</span>      <span class="token operator">&lt;</span>ListAllMyBucketsResult xmlns<span class="token operator">=</span><span class="token string">"http://s3.amazonaws.com/doc/2006-03-01"</span><span class="token operator">></span> <span class="token operator">|</span>          <span class="token operator">&lt;</span>Owner<span class="token operator">></span> <span class="token operator">|</span>          <span class="token operator">&lt;</span>ID<span class="token operator">></span>bcaf1ffd86f461ca5fb16fd081034f<span class="token operator">&lt;</span><span class="token operator">/</span>ID<span class="token operator">></span> <span class="token operator">|</span>          <span class="token operator">&lt;</span>DisplayName<span class="token operator">></span>webfile<span class="token operator">&lt;</span><span class="token operator">/</span>DisplayName<span class="token operator">></span> <span class="token operator">|</span>          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">|</span>   <span class="token operator">|</span>  This example lists your buckets <span class="token keyword">in</span> the eu<span class="token operator">-</span>west<span class="token number">-1</span> region of the Amazon S3 <span class="token operator">|</span>  service<span class="token punctuation">.</span> <span class="token operator">|</span>   <span class="token operator">|</span>  STS Temporary Credentials <span class="token operator">|</span>  <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token operator">|</span>  <span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> requests_aws4auth <span class="token keyword">import</span> AWS4Auth <span class="token operator">|</span>  <span class="token operator">>></span><span class="token operator">></span> auth <span class="token operator">=</span> AWS4Auth<span class="token punctuation">(</span><span class="token string">'&lt;ACCESS ID>'</span><span class="token punctuation">,</span> <span class="token string">'&lt;ACCESS KEY>'</span><span class="token punctuation">,</span> <span class="token string">'eu-west-1'</span><span class="token punctuation">,</span> <span class="token string">'s3'</span><span class="token punctuation">,</span> <span class="token operator">|</span>                      session_token<span class="token operator">=</span><span class="token string">'&lt;SESSION TOKEN>'</span><span class="token punctuation">)</span> <span class="token operator">|</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">|</span>   <span class="token operator">|</span>  This example shows how to construct an AWS4Auth object <span class="token keyword">for</span> use <span class="token keyword">with</span> STS <span class="token operator">|</span>  temporary credentials<span class="token punctuation">.</span> The ``x<span class="token operator">-</span>amz<span class="token operator">-</span>security<span class="token operator">-</span>token`` header <span class="token keyword">is</span> added <span class="token keyword">with</span> <span class="token operator">|</span>  the session token<span class="token punctuation">.</span> Temporary credential timeouts are <span class="token operator">not</span> managed <span class="token operator">-</span><span class="token operator">-</span> <span class="token keyword">in</span> <span class="token operator">|</span>  case the temporary credentials expire<span class="token punctuation">,</span> they need to be re<span class="token operator">-</span>generated <span class="token operator">and</span> <span class="token operator">|</span>  the AWS4Auth object re<span class="token operator">-</span>constructed <span class="token keyword">with</span> the new credentials<span class="token punctuation">.</span> <span class="token operator">|</span>   <span class="token operator">|</span>  Dynamic STS Credentials using botocore RefreshableCredentials <span class="token operator">|</span>  <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token operator">|</span>  <span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> requests_aws4auth <span class="token keyword">import</span> AWS4Auth <span class="token operator">|</span>  <span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> botocore<span class="token punctuation">.</span>session <span class="token keyword">import</span> Session <span class="token operator">|</span>  <span class="token operator">>></span><span class="token operator">></span> credentials <span class="token operator">=</span> Session<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_credentials<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|</span>  <span class="token operator">>></span><span class="token operator">></span> auth <span class="token operator">=</span> AWS4Auth<span class="token punctuation">(</span>region<span class="token operator">=</span><span class="token string">'eu-west-1'</span><span class="token punctuation">,</span> service<span class="token operator">=</span><span class="token string">'es'</span><span class="token punctuation">,</span> <span class="token operator">|</span>                      refreshable_credentials<span class="token operator">=</span>credentials<span class="token punctuation">)</span> <span class="token operator">|</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">|</span>   <span class="token operator">|</span>  This example shows how to construct an AWS4Auth instance <span class="token keyword">with</span> <span class="token operator">|</span>  automatically refreshing credentials<span class="token punctuation">,</span> suitable <span class="token keyword">for</span> long<span class="token operator">-</span>running <span class="token operator">|</span>  applications using AWS IAM assume<span class="token operator">-</span>role<span class="token punctuation">.</span> <span class="token operator">|</span>  The RefreshableCredentials instance <span class="token keyword">is</span> used to generate valid static <span class="token operator">|</span>  credentials per<span class="token operator">-</span>request<span class="token punctuation">,</span> eliminating the need to recreate the AWS4Auth <span class="token operator">|</span>  instance when temporary credentials expire<span class="token punctuation">.</span> <span class="token operator">|</span>   <span class="token operator">|</span>  Date handling <span class="token operator">|</span>  <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token operator">|</span>  If an HTTP request to be authenticated contains a Date <span class="token operator">or</span> X<span class="token operator">-</span>Amz<span class="token operator">-</span>Date <span class="token operator">|</span>  header<span class="token punctuation">,</span> AWS will only accept authorisation <span class="token keyword">if</span> the date <span class="token keyword">in</span> the header <span class="token operator">|</span>  matches the scope date of the signing key <span class="token punctuation">(</span>see <span class="token operator">|</span>  http<span class="token punctuation">:</span><span class="token operator">//</span>docs<span class="token punctuation">.</span>aws<span class="token punctuation">.</span>amazon<span class="token punctuation">.</span>com<span class="token operator">/</span>general<span class="token operator">/</span>latest<span class="token operator">/</span>gr<span class="token operator">/</span>sigv4<span class="token operator">-</span>date<span class="token operator">-</span>handling<span class="token punctuation">.</span>html<span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token operator">|</span>   <span class="token operator">|</span>  From version <span class="token number">0.8</span> of requests<span class="token operator">-</span>aws4auth<span class="token punctuation">,</span> <span class="token keyword">if</span> the header date does <span class="token operator">not</span> match <span class="token operator">|</span>  the scope date<span class="token punctuation">,</span> the AWS4Auth <span class="token keyword">class</span> <span class="token class-name">will</span> automatically regenerate its <span class="token operator">|</span>  signing key<span class="token punctuation">,</span> using the same scope parameters <span class="token keyword">as</span> the previous key <span class="token keyword">except</span> <span class="token keyword">for</span> <span class="token operator">|</span>  the date<span class="token punctuation">,</span> which will be changed to match the request date<span class="token punctuation">.</span> <span class="token punctuation">(</span>If a request <span class="token operator">|</span>  does <span class="token operator">not</span> include a date<span class="token punctuation">,</span> the current date <span class="token keyword">is</span> added to the request <span class="token keyword">in</span> an <span class="token operator">|</span>  X<span class="token operator">-</span>Amz<span class="token operator">-</span>Date header<span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token operator">|</span>   <span class="token operator">|</span>  The new behaviour <span class="token keyword">from</span> version <span class="token number">0.8</span> has implications <span class="token keyword">for</span> thread safety <span class="token operator">and</span> <span class="token operator">|</span>  secret key security<span class="token punctuation">,</span> see the <span class="token string">"Automatic key regeneration"</span><span class="token punctuation">,</span> "Secret key <span class="token operator">|</span>  storage<span class="token string">" and "</span>Multithreading" sections below<span class="token punctuation">.</span> <span class="token operator">|</span>   <span class="token operator">|</span>  This also means that AWS4Auth <span class="token keyword">is</span> now attempting to parse <span class="token operator">and</span> extract dates <span class="token operator">|</span>  <span class="token keyword">from</span> the values <span class="token keyword">in</span> X<span class="token operator">-</span>Amz<span class="token operator">-</span>Date <span class="token operator">and</span> Date headers<span class="token punctuation">.</span> Supported date formats are<span class="token punctuation">:</span> <span class="token operator">|</span>   <span class="token operator">|</span>      <span class="token operator">*</span> RFC <span class="token number">7231</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> Mon<span class="token punctuation">,</span> <span class="token number">09</span> Sep <span class="token number">2011</span> <span class="token number">23</span><span class="token punctuation">:</span><span class="token number">36</span><span class="token punctuation">:</span><span class="token number">00</span> GMT<span class="token punctuation">)</span> <span class="token operator">|</span>      <span class="token operator">*</span> RFC <span class="token number">850</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> Sunday<span class="token punctuation">,</span> <span class="token number">06</span><span class="token operator">-</span>Nov<span class="token number">-94</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">49</span><span class="token punctuation">:</span><span class="token number">37</span> GMT<span class="token punctuation">)</span> <span class="token operator">|</span>      <span class="token operator">*</span> C time <span class="token punctuation">(</span>e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> Wed Dec <span class="token number">4</span> <span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span> <span class="token number">2002</span><span class="token punctuation">)</span> <span class="token operator">|</span>      <span class="token operator">*</span> Amz<span class="token operator">-</span>Date format <span class="token punctuation">(</span>e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> 20090325T010101Z<span class="token punctuation">)</span> <span class="token operator">|</span>      <span class="token operator">*</span> ISO <span class="token number">8601</span> <span class="token operator">/</span> RFC <span class="token number">3339</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> <span class="token number">2009</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span>25T10<span class="token punctuation">:</span><span class="token number">11</span><span class="token punctuation">:</span><span class="token number">12.13</span><span class="token operator">-</span><span class="token number">01</span><span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">)</span> <span class="token operator">|</span>   <span class="token operator">|</span>  If either header <span class="token keyword">is</span> present but AWS4Auth cannot extract a date because all <span class="token operator">|</span>  present date headers are <span class="token keyword">in</span> an unrecognisable format<span class="token punctuation">,</span> AWS4Auth will delete <span class="token operator">|</span>  any X<span class="token operator">-</span>Amz<span class="token operator">-</span>Date <span class="token operator">and</span> Date headers present <span class="token operator">and</span> replace <span class="token keyword">with</span> a single <span class="token operator">|</span>  X<span class="token operator">-</span>Amz<span class="token operator">-</span>Date header containing the current date<span class="token punctuation">.</span> This behaviour can be <span class="token operator">|</span>  modified using the <span class="token string">'raise_invalid_date'</span> keyword argument of the AWS4Auth <span class="token operator">|</span>  constructor<span class="token punctuation">.</span> <span class="token operator">|</span>   <span class="token operator">|</span>  Automatic key regeneration <span class="token operator">|</span>  <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token operator">|</span>  If you do <span class="token operator">not</span> want the signing key to be automatically regenerated when a <span class="token operator">|</span>  mismatch between the request date <span class="token operator">and</span> the scope date <span class="token keyword">is</span> encountered<span class="token punctuation">,</span> use <span class="token operator">|</span>  the alternative StrictAWS4Auth <span class="token keyword">class</span><span class="token punctuation">,</span> which <span class="token keyword">is</span> identical to AWS4Auth <span class="token keyword">except</span> <span class="token operator">|</span>  that upon encountering a date mismatch it just raises a DateMismatchError<span class="token punctuation">.</span> <span class="token operator">|</span>  You can also use the PassiveAWS4Auth <span class="token keyword">class</span><span class="token punctuation">,</span> which mimics the AWS4Auth <span class="token operator">|</span>  behaviour prior to version <span class="token number">0.8</span> <span class="token operator">and</span> just signs <span class="token operator">and</span> sends the request<span class="token punctuation">,</span> <span class="token operator">|</span>  whether the date matches <span class="token operator">or</span> <span class="token operator">not</span><span class="token punctuation">.</span> In this case it <span class="token keyword">is</span> up to the calling code <span class="token operator">|</span>  to handle an authentication failure response <span class="token keyword">from</span> AWS caused by a date <span class="token operator">|</span>  mismatch<span class="token punctuation">.</span> <span class="token operator">|</span>   <span class="token operator">|</span>  Secret key storage <span class="token operator">|</span>  <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token operator">|</span>  To allow automatic key regeneration<span class="token punctuation">,</span> the secret key <span class="token keyword">is</span> stored <span class="token keyword">in</span> the <span class="token operator">|</span>  AWS4Auth instance<span class="token punctuation">,</span> <span class="token keyword">in</span> the signing key object<span class="token punctuation">.</span> If you do <span class="token operator">not</span> want this to <span class="token operator">|</span>  occur<span class="token punctuation">,</span> instantiate the instance using an AWS4Signing key which was created <span class="token operator">|</span>  <span class="token keyword">with</span> the store_secret_key parameter set to <span class="token boolean">False</span><span class="token punctuation">:</span> <span class="token operator">|</span>   <span class="token operator">|</span>  <span class="token operator">>></span><span class="token operator">></span> sig_key <span class="token operator">=</span> AWS4SigningKey<span class="token punctuation">(</span>secret_key<span class="token punctuation">,</span> region<span class="token punctuation">,</span> service<span class="token punctuation">,</span> date<span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token operator">|</span>  <span class="token operator">>></span><span class="token operator">></span> auth <span class="token operator">=</span> StrictAWS4Auth<span class="token punctuation">(</span>access_id<span class="token punctuation">,</span> sig_key<span class="token punctuation">)</span> <span class="token operator">|</span>   <span class="token operator">|</span>  The AWS4Auth <span class="token keyword">class</span> <span class="token class-name">will</span> then <span class="token keyword">raise</span> a NoSecretKeyError when it attempts to <span class="token operator">|</span>  regenerate its key<span class="token punctuation">.</span> A slightly more conceptually elegant way to handle this <span class="token operator">|</span>  <span class="token keyword">is</span> to use the alternative StrictAWS4Auth <span class="token keyword">class</span><span class="token punctuation">,</span> again instantiating it <span class="token keyword">with</span> <span class="token operator">|</span>  an AWS4SigningKey instance created <span class="token keyword">with</span> store_secret_key <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">.</span> <span class="token operator">|</span>   <span class="token operator">|</span>  Multithreading <span class="token operator">|</span>  <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token operator">|</span>  If you share AWS4Auth <span class="token punctuation">(</span><span class="token operator">or</span> even StrictAWS4Auth<span class="token punctuation">)</span> instances between threads <span class="token operator">|</span>  you are likely to encounter problems<span class="token punctuation">.</span> Because AWS4Auth instances may <span class="token operator">|</span>  unpredictably regenerate their signing key <span class="token keyword">as</span> part of signing a request<span class="token punctuation">,</span> <span class="token operator">|</span>  threads using the same instance may find the key changed by another thread <span class="token operator">|</span>  halfway through the signing process<span class="token punctuation">,</span> which may result <span class="token keyword">in</span> undefined <span class="token operator">|</span>  behaviour<span class="token punctuation">.</span> <span class="token operator">|</span>   <span class="token operator">|</span>  It may be possible to rig up a workable instance sharing mechanism using <span class="token operator">|</span>  locking primitives <span class="token operator">and</span> the StrictAWS4Auth <span class="token keyword">class</span><span class="token punctuation">,</span> however this poor author <span class="token operator">|</span>  can<span class="token string">'t think of a scenario which works safely yet doesn'</span>t suffer <span class="token keyword">from</span> at <span class="token operator">|</span>  some point blocking all threads <span class="token keyword">for</span> at least the duration of an HTTP <span class="token operator">|</span>  request<span class="token punctuation">,</span> which could be several seconds<span class="token punctuation">.</span> If several requests come <span class="token keyword">in</span> <span class="token keyword">in</span> <span class="token operator">|</span>  close succession which all require key regenerations then the system could <span class="token operator">|</span>  be forced into serial operation <span class="token keyword">for</span> quite a length of time<span class="token punctuation">.</span> <span class="token operator">|</span>   <span class="token operator">|</span>  In short<span class="token punctuation">,</span> it's best to create a thread<span class="token operator">-</span>local instance of AWS4Auth <span class="token keyword">for</span> each <span class="token operator">|</span>  thread that needs to do authentication<span class="token punctuation">.</span> <span class="token operator">|</span>   <span class="token operator">|</span>  Class <span class="token class-name">attributes</span> <span class="token operator">|</span>  <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token operator">|</span>  AWS4Auth<span class="token punctuation">.</span>access_id   <span class="token operator">-</span><span class="token operator">-</span> the access ID supplied to the instance <span class="token operator">|</span>  AWS4Auth<span class="token punctuation">.</span>region      <span class="token operator">-</span><span class="token operator">-</span> the AWS region <span class="token keyword">for</span> the instance <span class="token operator">|</span>  AWS4Auth<span class="token punctuation">.</span>service     <span class="token operator">-</span><span class="token operator">-</span> the endpoint code <span class="token keyword">for</span> the service <span class="token keyword">for</span> this instance <span class="token operator">|</span>  AWS4Auth<span class="token punctuation">.</span>date        <span class="token operator">-</span><span class="token operator">-</span> the date the instance <span class="token keyword">is</span> valid <span class="token keyword">for</span> <span class="token operator">|</span>  AWS4Auth<span class="token punctuation">.</span>signing_key <span class="token operator">-</span><span class="token operator">-</span> instance of AWS4SigningKey used <span class="token keyword">for</span> this instance<span class="token punctuation">,</span> <span class="token operator">|</span>                          either generated <span class="token keyword">from</span> the supplied parameters <span class="token operator">or</span> <span class="token operator">|</span>                          supplied directly on the command line <span class="token operator">|</span>   <span class="token operator">|</span>  Method resolution order<span class="token punctuation">:</span> <span class="token operator">|</span>      AWS4Auth <span class="token operator">|</span>      requests<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>AuthBase <span class="token operator">|</span>      builtins<span class="token punctuation">.</span>object <span class="token operator">|</span>   <span class="token operator">|</span>  Methods defined here<span class="token punctuation">:</span> <span class="token operator">|</span>   <span class="token operator">|</span>  __call__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> req<span class="token punctuation">)</span> <span class="token operator">|</span>      Interface used by Requests module to apply authentication to HTTP <span class="token operator">|</span>      requests<span class="token punctuation">.</span> <span class="token operator">|</span>       <span class="token operator">|</span>      Add x<span class="token operator">-</span>amz<span class="token operator">-</span>content<span class="token operator">-</span>sha256 <span class="token operator">and</span> Authorization headers to the request<span class="token punctuation">.</span> Add <span class="token operator">|</span>      x<span class="token operator">-</span>amz<span class="token operator">-</span>date header to request <span class="token keyword">if</span> <span class="token operator">not</span> already present <span class="token operator">and</span> req does <span class="token operator">not</span> <span class="token operator">|</span>      contain a Date header<span class="token punctuation">.</span> <span class="token operator">|</span>       <span class="token operator">|</span>      Check request date matches date <span class="token keyword">in</span> the current signing key<span class="token punctuation">.</span> If <span class="token operator">not</span><span class="token punctuation">,</span> <span class="token operator">|</span>      regenerate signing key to match request date<span class="token punctuation">.</span> <span class="token operator">|</span>       <span class="token operator">|</span>      If request body <span class="token keyword">is</span> <span class="token operator">not</span> already encoded to bytes<span class="token punctuation">,</span> encode to charset <span class="token operator">|</span>      specified <span class="token keyword">in</span> Content<span class="token operator">-</span>Type header<span class="token punctuation">,</span> <span class="token operator">or</span> UTF<span class="token number">-8</span> <span class="token keyword">if</span> <span class="token operator">not</span> specified<span class="token punctuation">.</span> <span class="token operator">|</span>       <span class="token operator">|</span>      req <span class="token operator">-</span><span class="token operator">-</span> Requests PreparedRequest object <span class="token operator">|</span>   <span class="token operator">|</span>  __init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span> <span class="token operator">|</span>      AWS4Auth instances can be created by supplying key scope parameters <span class="token operator">|</span>      directly <span class="token operator">or</span> by using an AWS4SigningKey instance<span class="token punctuation">:</span> <span class="token operator">|</span>       <span class="token operator">|</span>      <span class="token operator">>></span><span class="token operator">></span> auth <span class="token operator">=</span> AWS4Auth<span class="token punctuation">(</span>access_id<span class="token punctuation">,</span> secret_key<span class="token punctuation">,</span> region<span class="token punctuation">,</span> service <span class="token operator">|</span>      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                 <span class="token punctuation">[</span><span class="token punctuation">,</span> date<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">,</span> raise_invalid_date<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">,</span> session_token<span class="token operator">=</span>None<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">|</span>       <span class="token operator">|</span>        <span class="token operator">or</span> <span class="token operator">|</span>       <span class="token operator">|</span>      <span class="token operator">>></span><span class="token operator">></span> auth <span class="token operator">=</span> AWS4Auth<span class="token punctuation">(</span>access_id<span class="token punctuation">,</span> signing_key<span class="token punctuation">[</span><span class="token punctuation">,</span> raise_invalid_date<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">|</span>       <span class="token operator">|</span>        <span class="token operator">or</span> using auto<span class="token operator">-</span>refreshed STS temporary creds via botocore RefreshableCredentials <span class="token operator">|</span>        <span class="token punctuation">(</span>useful <span class="token keyword">for</span> long<span class="token operator">-</span>running processes<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token operator">|</span>       <span class="token operator">|</span>      <span class="token operator">>></span><span class="token operator">></span> auth <span class="token operator">=</span> AWS4Auth<span class="token punctuation">(</span>refreshable_credentials<span class="token operator">=</span>botocore<span class="token punctuation">.</span>session<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_credentials<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">|</span>      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                 region<span class="token operator">=</span><span class="token string">'eu-west-1'</span><span class="token punctuation">,</span> service<span class="token operator">=</span><span class="token string">'es'</span><span class="token punctuation">)</span> <span class="token operator">|</span>       <span class="token operator">|</span>      access_id   <span class="token operator">-</span><span class="token operator">-</span> This <span class="token keyword">is</span> your AWS access ID <span class="token operator">|</span>      secret_key  <span class="token operator">-</span><span class="token operator">-</span> This <span class="token keyword">is</span> your AWS secret access key <span class="token operator">|</span>      region      <span class="token operator">-</span><span class="token operator">-</span> The region you're connecting to<span class="token punctuation">,</span> <span class="token keyword">as</span> per the list at <span class="token operator">|</span>                     http<span class="token punctuation">:</span><span class="token operator">//</span>docs<span class="token punctuation">.</span>aws<span class="token punctuation">.</span>amazon<span class="token punctuation">.</span>com<span class="token operator">/</span>general<span class="token operator">/</span>latest<span class="token operator">/</span>gr<span class="token operator">/</span>rande<span class="token punctuation">.</span>html<span class="token comment" spellcheck="true">#s3_region</span> <span class="token operator">|</span>                     e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> us<span class="token operator">-</span>east<span class="token number">-1</span><span class="token punctuation">.</span> For services which don't require a region <span class="token operator">|</span>                     <span class="token punctuation">(</span>e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> IAM<span class="token punctuation">)</span><span class="token punctuation">,</span> use us<span class="token operator">-</span>east<span class="token number">-1</span><span class="token punctuation">.</span> <span class="token operator">|</span>                     Must be supplied <span class="token keyword">as</span> a keyword argument iff refreshable_credentials <span class="token operator">|</span>                     <span class="token keyword">is</span> set<span class="token punctuation">.</span> <span class="token operator">|</span>      service     <span class="token operator">-</span><span class="token operator">-</span> The name of the service you're connecting to<span class="token punctuation">,</span> <span class="token keyword">as</span> per <span class="token operator">|</span>                     endpoints at<span class="token punctuation">:</span> <span class="token operator">|</span>                     http<span class="token punctuation">:</span><span class="token operator">//</span>docs<span class="token punctuation">.</span>aws<span class="token punctuation">.</span>amazon<span class="token punctuation">.</span>com<span class="token operator">/</span>general<span class="token operator">/</span>latest<span class="token operator">/</span>gr<span class="token operator">/</span>rande<span class="token punctuation">.</span>html <span class="token operator">|</span>                     e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> elasticbeanstalk<span class="token punctuation">.</span> <span class="token operator">|</span>                     Must be supplied <span class="token keyword">as</span> a keyword argument iff refreshable_credentials <span class="token operator">|</span>                     <span class="token keyword">is</span> set<span class="token punctuation">.</span> <span class="token operator">|</span>      date        <span class="token operator">-</span><span class="token operator">-</span> Date this instance <span class="token keyword">is</span> valid <span class="token keyword">for</span><span class="token punctuation">.</span> <span class="token number">8</span><span class="token operator">-</span>digit date <span class="token keyword">as</span> str of the <span class="token operator">|</span>                     form YYYYMMDD<span class="token punctuation">.</span> Key <span class="token keyword">is</span> only valid <span class="token keyword">for</span> requests <span class="token keyword">with</span> a <span class="token operator">|</span>                     Date <span class="token operator">or</span> X<span class="token operator">-</span>Amz<span class="token operator">-</span>Date header matching this date<span class="token punctuation">.</span> If date <span class="token keyword">is</span> <span class="token operator">|</span>                     <span class="token operator">not</span> supplied the current date <span class="token keyword">is</span> used<span class="token punctuation">.</span> <span class="token operator">|</span>      signing_key <span class="token operator">-</span><span class="token operator">-</span> An AWS4SigningKey instance<span class="token punctuation">.</span> <span class="token operator">|</span>      raise_invalid_date <span class="token operator">|</span>                  <span class="token operator">-</span><span class="token operator">-</span> Must be supplied <span class="token keyword">as</span> keyword argument<span class="token punctuation">.</span> AWS4Auth tries to <span class="token operator">|</span>                     parse a date <span class="token keyword">from</span> the X<span class="token operator">-</span>Amz<span class="token operator">-</span>Date <span class="token operator">and</span> Date headers of the <span class="token operator">|</span>                     request<span class="token punctuation">,</span> first trying X<span class="token operator">-</span>Amz<span class="token operator">-</span>Date<span class="token punctuation">,</span> <span class="token operator">and</span> then Date <span class="token keyword">if</span> <span class="token operator">|</span>                     X<span class="token operator">-</span>Amz<span class="token operator">-</span>Date <span class="token keyword">is</span> <span class="token operator">not</span> present <span class="token operator">or</span> <span class="token keyword">is</span> <span class="token keyword">in</span> an unrecognised <span class="token operator">|</span>                     format<span class="token punctuation">.</span> If one <span class="token operator">or</span> both of the two headers are present <span class="token operator">|</span>                     yet neither are <span class="token keyword">in</span> a format which AWS4Auth recognises <span class="token operator">|</span>                     then it will remove both headers <span class="token operator">and</span> replace <span class="token keyword">with</span> a new <span class="token operator">|</span>                     X<span class="token operator">-</span>Amz<span class="token operator">-</span>Date header using the current date<span class="token punctuation">.</span> <span class="token operator">|</span>       <span class="token operator">|</span>                     If this behaviour <span class="token keyword">is</span> <span class="token operator">not</span> wanted<span class="token punctuation">,</span> set the <span class="token operator">|</span>                     raise_invalid_date keyword argument to <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token operator">and</span> <span class="token operator">|</span>                     instead an InvalidDateError will be raised when neither <span class="token operator">|</span>                     date <span class="token keyword">is</span> recognised<span class="token punctuation">.</span> If neither header <span class="token keyword">is</span> present at all <span class="token operator">|</span>                     then an X<span class="token operator">-</span>Amz<span class="token operator">-</span>Date header will still be added containing <span class="token operator">|</span>                     the current date<span class="token punctuation">.</span> <span class="token operator">|</span>       <span class="token operator">|</span>                     See the AWS4Auth <span class="token keyword">class</span> <span class="token class-name">docstring</span> <span class="token keyword">for</span> supported date <span class="token operator">|</span>                     formats<span class="token punctuation">.</span> <span class="token operator">|</span>      session_token <span class="token operator">|</span>                  <span class="token operator">-</span><span class="token operator">-</span> Must be supplied <span class="token keyword">as</span> keyword argument<span class="token punctuation">.</span> If session_token <span class="token operator">|</span>                     <span class="token keyword">is</span> set<span class="token punctuation">,</span> then it <span class="token keyword">is</span> used <span class="token keyword">for</span> the x<span class="token operator">-</span>amz<span class="token operator">-</span>security<span class="token operator">-</span>token <span class="token operator">|</span>                     header<span class="token punctuation">,</span> <span class="token keyword">for</span> use <span class="token keyword">with</span> STS temporary credentials<span class="token punctuation">.</span> <span class="token operator">|</span>      refreshable_credentials <span class="token operator">|</span>                  <span class="token operator">-</span><span class="token operator">-</span> A botocore<span class="token punctuation">.</span>credentials<span class="token punctuation">.</span>RefreshableCredentials instance<span class="token punctuation">.</span> <span class="token operator">|</span>                     Must be supplied <span class="token keyword">as</span> keyword argument<span class="token punctuation">.</span> This instance <span class="token keyword">is</span> <span class="token operator">|</span>                     used to generate valid per<span class="token operator">-</span>request static credentials<span class="token punctuation">,</span> <span class="token operator">|</span>                     without needing to re<span class="token operator">-</span>generate the AWS4Auth instance<span class="token punctuation">.</span>                        <span class="token operator">|</span>                     If refreshable_credentials <span class="token keyword">is</span> set<span class="token punctuation">,</span> the following arguments <span class="token operator">|</span>                     are ignored<span class="token punctuation">:</span> access_id<span class="token punctuation">,</span> secret_key<span class="token punctuation">,</span> signing_key<span class="token punctuation">,</span> <span class="token operator">|</span>                     session_token<span class="token punctuation">.</span> <span class="token operator">|</span>   <span class="token operator">|</span>  amz_cano_path<span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span> <span class="token operator">|</span>      Generate the canonical path <span class="token keyword">as</span> per AWS4 auth requirements<span class="token punctuation">.</span> <span class="token operator">|</span>       <span class="token operator">|</span>      Not documented anywhere<span class="token punctuation">,</span> determined <span class="token keyword">from</span> aws4_testsuite examples<span class="token punctuation">,</span> <span class="token operator">|</span>      problem reports <span class="token operator">and</span> testing against the live services<span class="token punctuation">.</span> <span class="token operator">|</span>       <span class="token operator">|</span>      path <span class="token operator">-</span><span class="token operator">-</span> request path <span class="token operator">|</span>   <span class="token operator">|</span>  get_canonical_request<span class="token punctuation">(</span>self<span class="token punctuation">,</span> req<span class="token punctuation">,</span> cano_headers<span class="token punctuation">,</span> signed_headers<span class="token punctuation">)</span> <span class="token operator">|</span>      Create the AWS authentication Canonical Request string<span class="token punctuation">.</span> <span class="token operator">|</span>       <span class="token operator">|</span>      req            <span class="token operator">-</span><span class="token operator">-</span> Requests<span class="token operator">/</span>Httpx PreparedRequest object<span class="token punctuation">.</span> Should already <span class="token operator">|</span>                        include an x<span class="token operator">-</span>amz<span class="token operator">-</span>content<span class="token operator">-</span>sha256 header <span class="token operator">|</span>      cano_headers   <span class="token operator">-</span><span class="token operator">-</span> Canonical Headers section of Canonical Request<span class="token punctuation">,</span> <span class="token keyword">as</span> <span class="token operator">|</span>                        returned by get_canonical_headers<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|</span>      signed_headers <span class="token operator">-</span><span class="token operator">-</span> Signed Headers<span class="token punctuation">,</span> <span class="token keyword">as</span> returned by <span class="token operator">|</span>                        get_canonical_headers<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|</span>   <span class="token operator">|</span>  handle_date_mismatch<span class="token punctuation">(</span>self<span class="token punctuation">,</span> req<span class="token punctuation">)</span> <span class="token operator">|</span>      Handle a request whose date doesn't match the signing key scope date<span class="token punctuation">.</span> <span class="token operator">|</span>       <span class="token operator">|</span>      This AWS4Auth <span class="token keyword">class</span> <span class="token class-name">implementation</span> regenerates the signing key<span class="token punctuation">.</span> See <span class="token operator">|</span>      StrictAWS4Auth <span class="token keyword">class</span> <span class="token class-name">if</span> you would prefer an exception to be raised<span class="token punctuation">.</span> <span class="token operator">|</span>       <span class="token operator">|</span>      req <span class="token operator">-</span><span class="token operator">-</span> a requests prepared request object <span class="token operator">|</span>   <span class="token operator">|</span>  refresh_credentials<span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">|</span>   <span class="token operator">|</span>  regenerate_signing_key<span class="token punctuation">(</span>self<span class="token punctuation">,</span> secret_key<span class="token operator">=</span>None<span class="token punctuation">,</span> region<span class="token operator">=</span>None<span class="token punctuation">,</span> service<span class="token operator">=</span>None<span class="token punctuation">,</span> date<span class="token operator">=</span>None<span class="token punctuation">)</span> <span class="token operator">|</span>      Regenerate the signing key <span class="token keyword">for</span> this instance<span class="token punctuation">.</span> Store the new key <span class="token keyword">in</span> <span class="token operator">|</span>      signing_key property<span class="token punctuation">.</span> <span class="token operator">|</span>       <span class="token operator">|</span>      Take scope elements of the new key <span class="token keyword">from</span> the equivalent properties <span class="token operator">|</span>      <span class="token punctuation">(</span>region<span class="token punctuation">,</span> service<span class="token punctuation">,</span> date<span class="token punctuation">)</span> of the current AWS4Auth instance<span class="token punctuation">.</span> Scope <span class="token operator">|</span>      elements can be overridden <span class="token keyword">for</span> the new key by supplying arguments to <span class="token operator">|</span>      this function<span class="token punctuation">.</span> If overrides are supplied update the current AWS4Auth <span class="token operator">|</span>      instance's equivalent properties to match the new values<span class="token punctuation">.</span> <span class="token operator">|</span>       <span class="token operator">|</span>      If secret_key <span class="token keyword">is</span> <span class="token operator">not</span> specified use the value of the secret_key property <span class="token operator">|</span>      of the current AWS4Auth instance's signing key<span class="token punctuation">.</span> If the existing signing <span class="token operator">|</span>      key <span class="token keyword">is</span> <span class="token operator">not</span> storing its secret key <span class="token punctuation">(</span>i<span class="token punctuation">.</span>e<span class="token punctuation">.</span> store_secret_key was set to <span class="token operator">|</span>      <span class="token boolean">False</span> at instantiation<span class="token punctuation">)</span> then <span class="token keyword">raise</span> a NoSecretKeyError <span class="token operator">and</span> do <span class="token operator">not</span> <span class="token operator">|</span>      regenerate the key<span class="token punctuation">.</span> In order to regenerate a key which <span class="token keyword">is</span> <span class="token operator">not</span> storing <span class="token operator">|</span>      its secret key<span class="token punctuation">,</span> secret_key must be supplied to this function<span class="token punctuation">.</span> <span class="token operator">|</span>       <span class="token operator">|</span>      Use the value of the existing key's store_secret_key property when <span class="token operator">|</span>      generating the new key<span class="token punctuation">.</span> If there <span class="token keyword">is</span> no existing key<span class="token punctuation">,</span> then default <span class="token operator">|</span>      to setting store_secret_key to <span class="token boolean">True</span> <span class="token keyword">for</span> new key<span class="token punctuation">.</span> <span class="token operator">|</span>   <span class="token operator">|</span>  <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token operator">|</span>  Class <span class="token class-name">methods</span> defined here<span class="token punctuation">:</span> <span class="token operator">|</span>   <span class="token operator">|</span>  get_canonical_headers<span class="token punctuation">(</span>req<span class="token punctuation">,</span> include<span class="token operator">=</span>None<span class="token punctuation">)</span> <span class="token keyword">from</span> builtins<span class="token punctuation">.</span>type <span class="token operator">|</span>      Generate the Canonical Headers section of the Canonical Request<span class="token punctuation">.</span> <span class="token operator">|</span>       <span class="token operator">|</span>      Return the Canonical Headers <span class="token operator">and</span> the Signed Headers strs <span class="token keyword">as</span> a tuple <span class="token operator">|</span>      <span class="token punctuation">(</span>canonical_headers<span class="token punctuation">,</span> signed_headers<span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token operator">|</span>       <span class="token operator">|</span>      req     <span class="token operator">-</span><span class="token operator">-</span> Requests PreparedRequest object <span class="token operator">|</span>      include <span class="token operator">-</span><span class="token operator">-</span> List of headers to include <span class="token keyword">in</span> the canonical <span class="token operator">and</span> signed <span class="token operator">|</span>                 headers<span class="token punctuation">.</span> It's primarily included to allow testing against <span class="token operator">|</span>                 specific examples <span class="token keyword">from</span> Amazon<span class="token punctuation">.</span> If omitted <span class="token operator">or</span> None it <span class="token operator">|</span>                 includes host<span class="token punctuation">,</span> content<span class="token operator">-</span>type <span class="token operator">and</span> any header starting <span class="token string">'x-amz-'</span> <span class="token operator">|</span>                 <span class="token keyword">except</span> <span class="token keyword">for</span> x<span class="token operator">-</span>amz<span class="token operator">-</span>client context<span class="token punctuation">,</span> which appears to <span class="token keyword">break</span> <span class="token operator">|</span>                 mobile analytics auth <span class="token keyword">if</span> included<span class="token punctuation">.</span> Except <span class="token keyword">for</span> the <span class="token operator">|</span>                 x<span class="token operator">-</span>amz<span class="token operator">-</span>client<span class="token operator">-</span>context exclusion these defaults are per the <span class="token operator">|</span>                 AWS documentation<span class="token punctuation">.</span> <span class="token operator">|</span>   <span class="token operator">|</span>  get_request_date<span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token keyword">from</span> builtins<span class="token punctuation">.</span>type <span class="token operator">|</span>      Try to pull a date <span class="token keyword">from</span> the request by looking first at the <span class="token operator">|</span>      x<span class="token operator">-</span>amz<span class="token operator">-</span>date header<span class="token punctuation">,</span> <span class="token operator">and</span> <span class="token keyword">if</span> that's <span class="token operator">not</span> present then the Date header<span class="token punctuation">.</span> <span class="token operator">|</span>       <span class="token operator">|</span>      Return a datetime<span class="token punctuation">.</span>date object<span class="token punctuation">,</span> <span class="token operator">or</span> None <span class="token keyword">if</span> neither date header <span class="token operator">|</span>      <span class="token keyword">is</span> found <span class="token operator">or</span> <span class="token keyword">is</span> <span class="token keyword">in</span> a recognisable format<span class="token punctuation">.</span> <span class="token operator">|</span>       <span class="token operator">|</span>      req <span class="token operator">-</span><span class="token operator">-</span> a requests PreparedRequest object <span class="token operator">|</span>   <span class="token operator">|</span>  <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token operator">|</span>  Static methods defined here<span class="token punctuation">:</span> <span class="token operator">|</span>   <span class="token operator">|</span>  amz_cano_querystring<span class="token punctuation">(</span>qs<span class="token punctuation">)</span> <span class="token operator">|</span>      Parse <span class="token operator">and</span> format querystring <span class="token keyword">as</span> per AWS4 auth requirements<span class="token punctuation">.</span> <span class="token operator">|</span>       <span class="token operator">|</span>      Perform percent quoting <span class="token keyword">as</span> needed<span class="token punctuation">.</span> <span class="token operator">|</span>       <span class="token operator">|</span>      qs <span class="token operator">-</span><span class="token operator">-</span> querystring <span class="token operator">|</span>   <span class="token operator">|</span>  amz_norm_whitespace<span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token operator">|</span>      Replace runs of whitespace <span class="token keyword">with</span> a single space<span class="token punctuation">.</span> <span class="token operator">|</span>       <span class="token operator">|</span>      Ignore text enclosed <span class="token keyword">in</span> quotes<span class="token punctuation">.</span> <span class="token operator">|</span>   <span class="token operator">|</span>  encode_body<span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token operator">|</span>      Encode body of request to bytes <span class="token operator">and</span> update content<span class="token operator">-</span>type <span class="token keyword">if</span> required<span class="token punctuation">.</span> <span class="token operator">|</span>       <span class="token operator">|</span>      If the body of req <span class="token keyword">is</span> Unicode then encode to the charset found <span class="token keyword">in</span> <span class="token operator">|</span>      content<span class="token operator">-</span>type header <span class="token keyword">if</span> present<span class="token punctuation">,</span> otherwise UTF<span class="token number">-8</span><span class="token punctuation">,</span> <span class="token operator">or</span> ASCII <span class="token keyword">if</span> <span class="token operator">|</span>      content<span class="token operator">-</span>type <span class="token keyword">is</span> application<span class="token operator">/</span>x<span class="token operator">-</span>www<span class="token operator">-</span>form<span class="token operator">-</span>urlencoded<span class="token punctuation">.</span> If encoding to UTF<span class="token number">-8</span> <span class="token operator">|</span>      then add charset to content<span class="token operator">-</span>type<span class="token punctuation">.</span> Modifies req directly<span class="token punctuation">,</span> does <span class="token operator">not</span> <span class="token operator">|</span>      <span class="token keyword">return</span> a modified copy<span class="token punctuation">.</span> <span class="token operator">|</span>       <span class="token operator">|</span>      req <span class="token operator">-</span><span class="token operator">-</span> Requests PreparedRequest object <span class="token operator">|</span>   <span class="token operator">|</span>  get_sig_string<span class="token punctuation">(</span>req<span class="token punctuation">,</span> cano_req<span class="token punctuation">,</span> scope<span class="token punctuation">)</span> <span class="token operator">|</span>      Generate the AWS4 auth string to sign <span class="token keyword">for</span> the request<span class="token punctuation">.</span> <span class="token operator">|</span>       <span class="token operator">|</span>      req      <span class="token operator">-</span><span class="token operator">-</span> Requests PreparedRequest object<span class="token punctuation">.</span> This should already <span class="token operator">|</span>                  include an x<span class="token operator">-</span>amz<span class="token operator">-</span>date header<span class="token punctuation">.</span> <span class="token operator">|</span>      cano_req <span class="token operator">-</span><span class="token operator">-</span> The Canonical Request<span class="token punctuation">,</span> <span class="token keyword">as</span> returned by <span class="token operator">|</span>                  get_canonical_request<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|</span>   <span class="token operator">|</span>  parse_date<span class="token punctuation">(</span>date_str<span class="token punctuation">)</span> <span class="token operator">|</span>      Check <span class="token keyword">if</span> date_str <span class="token keyword">is</span> <span class="token keyword">in</span> a recognised format <span class="token operator">and</span> <span class="token keyword">return</span> an ISO <span class="token operator">|</span>      yyyy<span class="token operator">-</span>mm<span class="token operator">-</span>dd format version <span class="token keyword">if</span> so<span class="token punctuation">.</span> Raise DateFormatError <span class="token keyword">if</span> <span class="token operator">not</span><span class="token punctuation">.</span> <span class="token operator">|</span>       <span class="token operator">|</span>      Recognised formats are<span class="token punctuation">:</span> <span class="token operator">|</span>      <span class="token operator">*</span> RFC <span class="token number">7231</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> Mon<span class="token punctuation">,</span> <span class="token number">09</span> Sep <span class="token number">2011</span> <span class="token number">23</span><span class="token punctuation">:</span><span class="token number">36</span><span class="token punctuation">:</span><span class="token number">00</span> GMT<span class="token punctuation">)</span> <span class="token operator">|</span>      <span class="token operator">*</span> RFC <span class="token number">850</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> Sunday<span class="token punctuation">,</span> <span class="token number">06</span><span class="token operator">-</span>Nov<span class="token number">-94</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">49</span><span class="token punctuation">:</span><span class="token number">37</span> GMT<span class="token punctuation">)</span> <span class="token operator">|</span>      <span class="token operator">*</span> C time <span class="token punctuation">(</span>e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> Wed Dec <span class="token number">4</span> <span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span> <span class="token number">2002</span><span class="token punctuation">)</span> <span class="token operator">|</span>      <span class="token operator">*</span> Amz<span class="token operator">-</span>Date format <span class="token punctuation">(</span>e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> 20090325T010101Z<span class="token punctuation">)</span> <span class="token operator">|</span>      <span class="token operator">*</span> ISO <span class="token number">8601</span> <span class="token operator">/</span> RFC <span class="token number">3339</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> <span class="token number">2009</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span>25T10<span class="token punctuation">:</span><span class="token number">11</span><span class="token punctuation">:</span><span class="token number">12.13</span><span class="token operator">-</span><span class="token number">01</span><span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">)</span> <span class="token operator">|</span>       <span class="token operator">|</span>      date_str <span class="token operator">-</span><span class="token operator">-</span> Str containing a date <span class="token operator">and</span> optional time <span class="token operator">|</span>   <span class="token operator">|</span>  <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token operator">|</span>  Data <span class="token operator">and</span> other attributes defined here<span class="token punctuation">:</span> <span class="token operator">|</span>   <span class="token operator">|</span>  default_include_headers <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;'content-type', 'date', 'host', 'x-amz-*'&amp;#125;</span> <span class="token operator">|</span>   <span class="token operator">|</span>  <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token operator">|</span>  Data descriptors inherited <span class="token keyword">from</span> requests<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>AuthBase<span class="token punctuation">:</span> <span class="token operator">|</span>   <span class="token operator">|</span>  __dict__ <span class="token operator">|</span>      dictionary <span class="token keyword">for</span> instance variables <span class="token punctuation">(</span><span class="token keyword">if</span> defined<span class="token punctuation">)</span> <span class="token operator">|</span>   <span class="token operator">|</span>  __weakref__ <span class="token operator">|</span>      list of weak references to the object <span class="token punctuation">(</span><span class="token keyword">if</span> defined<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> aws sdk </category>
          
          <category> dev </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> boto3 </tag>
            
            <tag> http </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>本地使用SAM模拟Lambda</title>
      <link href="/2023/10/13/dev/lambda/sam/"/>
      <url>/2023/10/13/dev/lambda/sam/</url>
      
        <content type="html"><![CDATA[<p>AWS 提供了一个工具叫做 <code>AWS SAM (Serverless Application Model)</code>。以下是如何使用 SAM 在本地模拟 Lambda 函数的简单步骤：</p><ol><li><p><strong>安装 AWS SAM CLI</strong></p><p>需要先安装 <a href="https://www.docker.com/get-started">Docker</a> 和 AWS SAM CLI。安装 Docker 之后，可以使用以下命令安装 SAM CLI：</p><pre class="line-numbers language-bash"><code class="language-bash">pip <span class="token function">install</span> aws-sam-cli<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p><strong>初始化一个新的 SAM 项目</strong></p><p>如果你还没有一个 SAM 项目，你可以使用以下命令来创建一个：</p><pre class="line-numbers language-bash"><code class="language-bash">sam init --runtime python3.8<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这将会创建一个新的 SAM 项目，并使用 Python 3.8 作为运行时。你可以选择你喜欢的其他运行时，如 nodejs, java 等。</p></li><li><p><strong>本地模拟 Lambda 函数</strong></p><p>使用以下命令来启动本地的 Lambda 模拟器：</p><pre class="line-numbers language-bash"><code class="language-bash">sam local invoke<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这会启动一个 Docker 容器，模拟 Lambda 环境，并运行你的函数。</p><p>如果你有一个 API Gateway 的定义，并希望模拟整个 API，你可以使用以下命令：</p><pre class="line-numbers language-bash"><code class="language-bash">sam local start-api<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然后你可以向 <code>http://127.0.0.1:3000</code> 发送请求来模拟 API 调用。</p></li><li><p><strong>传递事件数据</strong></p><p>你可以使用 <code>-e</code> 参数传递一个事件文件给 <code>sam local invoke</code>。例如：</p><pre class="line-numbers language-bash"><code class="language-bash">sam local invoke -e events/event.json<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>其中 <code>events/event.json</code> 是包含模拟事件数据的文件。</p></li><li><p><strong>查看日志</strong></p><p>在模拟 Lambda 时，所有的输出和日志将直接打印到控制台，这使得调试和追踪问题变得更容易。</p></li><li><p><strong>停止模拟</strong></p><p>使用 <code>Ctrl + C</code> 可以停止模拟器。</p></li></ol><p><code>AWS SAM (Serverless Application Model)</code> 是一个用于构建 Serverless 应用的工具。以下是一些 <code>SAM CLI</code> 的常用命令：</p><ol><li><p><strong>初始化一个新的 SAM 项目</strong></p><pre class="line-numbers language-bash"><code class="language-bash">sam init<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>使用上述命令可以初始化一个新的 SAM 项目。你可以选择一个模板、运行时或其他选项来开始。</p></li><li><p><strong>在本地模拟 Lambda 函数</strong></p><pre class="line-numbers language-bash"><code class="language-bash">sam local invoke <span class="token punctuation">[</span>FunctionLogicalID<span class="token punctuation">]</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>使用该命令模拟 Lambda 函数执行。如果你的 template 文件中有多个函数，需要提供特定的 <code>FunctionLogicalID</code>。</p></li><li><p><strong>启动本地 API Gateway</strong></p><pre class="line-numbers language-bash"><code class="language-bash">sam local start-api<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果你的 SAM 模板定义了 API Gateway，你可以使用这个命令在本地启动一个模拟的 API Gateway。</p></li><li><p><strong>生成模拟事件</strong></p><pre class="line-numbers language-bash"><code class="language-bash">sam local generate-event<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>你可以使用这个命令来生成一个模拟的事件，如 S3 事件、API Gateway 事件等。</p></li><li><p><strong>打包 SAM 应用</strong></p><pre class="line-numbers language-bash"><code class="language-bash">sam package --template-file template.yaml --output-template-file packaged.yaml --s3-bucket YOUR_S3_BUCKET<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>使用上述命令将你的应用打包并上传到 S3 存储桶，为部署做准备。</p></li><li><p><strong>部署 SAM 应用</strong></p><pre class="line-numbers language-bash"><code class="language-bash">sam deploy --template-file packaged.yaml --stack-name YOUR_STACK_NAME --capabilities CAPABILITY_IAM<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>使用这个命令部署你的 SAM 应用到 AWS。</p></li><li><p><strong>快速打包和部署</strong></p><p>对于打包和部署，你也可以直接使用以下命令，SAM 会自动进行打包和部署：</p><pre class="line-numbers language-bash"><code class="language-bash">sam deploy --guided<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p><strong>验证 SAM 模板</strong></p><pre class="line-numbers language-bash"><code class="language-bash">sam validate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>使用这个命令验证你的 <code>template.yaml</code> 文件的语法和结构。</p></li><li><p><strong>构建 SAM 应用</strong></p><pre class="line-numbers language-bash"><code class="language-bash">sam build<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果你的函数依赖外部库或需要编译，使用这个命令可以构建它们。</p></li><li><p><strong>查看 SAM 日志</strong></p></li></ol><pre class="line-numbers language-bash"><code class="language-bash">sam logs -n FunctionLogicalID --stack-name YOUR_STACK_NAME<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>   使用这个命令可以查看部署在 AWS 上的函数的日志。</p><p>这只是 SAM CLI 的常用命令的概述。为了充分利用它，建议查阅 <a href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-command-reference.html">AWS SAM CLI 官方文档</a> 以了解更多详情和选项。</p><p>注意：虽然 SAM 提供了一个非常接近真实 AWS 环境的模拟，但仍然可能存在一些差异。因此，在部署到真实的 AWS 环境之前，最好还是进行充分的测试。</p>]]></content>
      
      
      <categories>
          
          <category> lambda </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Severless </tag>
            
            <tag> SAM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在lambda上运行 Typescript</title>
      <link href="/2023/10/13/dev/lambda/ts/"/>
      <url>/2023/10/13/dev/lambda/ts/</url>
      
        <content type="html"><![CDATA[<p>要在AWS Lambda上运行TypeScript，你需要将TypeScript代码编译为JavaScript，然后将其部署到Lambda。以下是如何实现这个目标的简要步骤：</p><ol><li>安装TypeScript：</li></ol><p>在你的项目根目录下运行以下命令，安装TypeScript和类型定义：</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">npm</span> init -y<span class="token function">npm</span> <span class="token function">install</span> typescript --save-dev<span class="token function">npm</span> <span class="token function">install</span> @types/node --save-dev<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ol start="2"><li>配置TypeScript：</li></ol><p>在项目根目录下创建一个名为<code>tsconfig.json</code>的文件，添加以下内容：</p><pre class="line-numbers language-json"><code class="language-json">&amp;#<span class="token number">123</span><span class="token punctuation">;</span>   <span class="token property">"compilerOptions"</span><span class="token operator">:</span> &amp;#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token property">"target"</span><span class="token operator">:</span> <span class="token string">"es2018"</span><span class="token punctuation">,</span>    <span class="token property">"module"</span><span class="token operator">:</span> <span class="token string">"commonjs"</span><span class="token punctuation">,</span>    <span class="token property">"outDir"</span><span class="token operator">:</span> <span class="token string">"dist"</span><span class="token punctuation">,</span>    <span class="token property">"strict"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token property">"esModuleInterop"</span><span class="token operator">:</span> <span class="token boolean">true</span>  &amp;#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span>  <span class="token property">"include"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"src"</span><span class="token punctuation">]</span>&amp;#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这会将<code>src</code>目录下的TypeScript代码编译到<code>dist</code>目录下的JavaScript代码。</p><ol start="3"><li>编写Lambda函数：</li></ol><p>在<code>src</code>目录下创建一个名为<code>handler.ts</code>的文件，并编写你的Lambda函数：</p><pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> APIGatewayProxyHandler <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">from</span> <span class="token string">'aws-lambda'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">const</span> hello<span class="token punctuation">:</span> APIGatewayProxyHandler <span class="token operator">=</span> async <span class="token punctuation">(</span>event<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>    statusCode<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>    body<span class="token punctuation">:</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>      message<span class="token punctuation">:</span> <span class="token string">'Hello from TypeScript Lambda!'</span><span class="token punctuation">,</span>    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="4"><li>编译TypeScript代码：</li></ol><p>在项目根目录下运行以下命令，将TypeScript代码编译为JavaScript：</p><pre class="line-numbers language-bash"><code class="language-bash">npx tsc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>编译后的JavaScript代码将出现在<code>dist</code>目录下。</p><ol start="5"><li>部署Lambda函数：</li></ol><p>你可以使用AWS CLI、Serverless Framework、AWS CDK等工具将编译后的Lambda函数部署到AWS。在这里，我们使用AWS CLI。</p><p>首先，安装并配置<a href="https://aws.amazon.com/cli/">AWS CLI</a>。</p><p>然后，将编译后的代码压缩为一个ZIP文件：</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">cd</span> dist<span class="token function">zip</span> -r lambda.zip <span class="token keyword">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>接下来，使用AWS CLI创建一个Lambda函数：</p><pre class="line-numbers language-bash"><code class="language-bash">aws lambda create-function \  --function-name your-function-name \  --runtime nodejs14.x \  --handler handler.hello \  --role arn:aws:iam::<span class="token operator">&lt;</span>your-account-id<span class="token operator">></span>:role/service-role/your-lambda-role \  --zip-file fileb://lambda.zip<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>将<code>your-function-name</code>替换为你希望使用的函数名称，将<code>&lt;your-account-id&gt;</code>替换为你的AWS帐户ID，将<code>your-lambda-role</code>替换为适当的IAM角色。</p><p>完成上述步骤后，你的TypeScript Lambda函数将部署到AWS Lambda，并准备好运行。你可以使用<code>aws lambda invoke</code>命令或AWS管理控制台测试和调用你的函数。</p>]]></content>
      
      
      <categories>
          
          <category> lambda </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Typescript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>S3 桶策略仅自己可见</title>
      <link href="/2023/10/13/storage/s3/s3-tong-ce-lue-jin-zi-ji-ke-jian/"/>
      <url>/2023/10/13/storage/s3/s3-tong-ce-lue-jin-zi-ji-ke-jian/</url>
      
        <content type="html"><![CDATA[<p>S3 桶策略仅自己可见,用allow放行自己，然后deny其他人，等于双重保险。</p><p>分析过程：</p><pre class="line-numbers language-json"><code class="language-json">&amp;#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>    <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        &amp;#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token property">"Sid"</span><span class="token operator">:</span> <span class="token string">"AllowSpecificUser"</span><span class="token punctuation">,</span>            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>            <span class="token property">"Principal"</span><span class="token operator">:</span> &amp;#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token property">"AWS"</span><span class="token operator">:</span> <span class="token string">"arn:aws:iam::ACCOUNT-ID:user/username"</span>            &amp;#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span>            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token string">"s3:*"</span><span class="token punctuation">,</span>            <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                <span class="token string">"arn:aws:s3:::YOUR-BUCKET-NAME"</span><span class="token punctuation">,</span>                <span class="token string">"arn:aws:s3:::YOUR-BUCKET-NAME/*"</span>            <span class="token punctuation">]</span>        &amp;#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span>        &amp;#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token property">"Sid"</span><span class="token operator">:</span> <span class="token string">"ExplicitDenyAllOthers"</span><span class="token punctuation">,</span>            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Deny"</span><span class="token punctuation">,</span>            <span class="token property">"NotPrincipal"</span><span class="token operator">:</span> &amp;#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token property">"AWS"</span><span class="token operator">:</span> <span class="token string">"arn:aws:iam::ACCOUNT-ID:user/username"</span>            &amp;#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span>            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token string">"s3:*"</span><span class="token punctuation">,</span>            <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                <span class="token string">"arn:aws:s3:::YOUR-BUCKET-NAME"</span><span class="token punctuation">,</span>                <span class="token string">"arn:aws:s3:::YOUR-BUCKET-NAME/*"</span>            <span class="token punctuation">]</span>        &amp;#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token punctuation">]</span>&amp;#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> s3 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> bucket policy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>S3 权限访问</title>
      <link href="/2023/10/13/storage/s3/s3-quan-xian-fang-wen/"/>
      <url>/2023/10/13/storage/s3/s3-quan-xian-fang-wen/</url>
      
        <content type="html"><![CDATA[<h3 id="本账号访问"><a href="#本账号访问" class="headerlink" title="本账号访问"></a>本账号访问</h3><h3 id="跨账户访问"><a href="#跨账户访问" class="headerlink" title="跨账户访问"></a>跨账户访问</h3><h3 id="匿名访问"><a href="#匿名访问" class="headerlink" title="匿名访问"></a>匿名访问</h3><h4 id="presigned-url-1-2"><a href="#presigned-url-1-2" class="headerlink" title="presigned url [^1] [^2]"></a>presigned url [^1] [^2]</h4><p>预签名 URL最长7天，中国区需要备案。</p><pre class="line-numbers language-bash"><code class="language-bash">aws s3 presign s3://DOC-EXAMPLE-BUCKET/test2.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>[^1]: <a href="https://docs.amazonaws.cn/zh_cn/AmazonS3/latest/userguide/using-presigned-url.html">使用预签名 URL - Amazon Simple Storage Service</a><br>[^2]: <a href="https://awscli.amazonaws.com/v2/documentation/api/latest/reference/s3/presign.html">presign — AWS CLI 2.7.23 Command Reference</a></p><p>没有备案</p><pre><code>&lt;Error&gt;&lt;Code&gt;UnauthorizedAccess&lt;/Code&gt;&lt;Message&gt;You are not authorized to perform this operation&lt;/Message&gt;&lt;RequestId&gt;X2Q67EZKB8CJ3PM72&lt;/RequestId&gt;&lt;HostId&gt;bc2h2Sbb76aDuZcS+Wd2lgdlN20cjnF+QqbEnFjTV8KxrsSMy+7tiJI6qx3tm9U4N&lt;/HostId&gt;&lt;/Error&gt;# 浏览器的报错GET https://xxxxx.s3.cn-north-1.amazonaws.com.cn/ec2.md?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=AKIATBIXRJFCVFQ36CED%2F20220925%2Fcn-north-1%2Fs3%2Faws4_request&amp;X-Amz-Date=20220925T021049Z&amp;X-Amz-Expires=3600&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=36bb107f012367108ded4444af70321f342323d0a7c860bbaefeb524161067e0 401 (Unauthorized)</code></pre><p>删除桶策略:</p><pre class="line-numbers language-bash"><code class="language-bash">aws s3api delete-bucket-policy --bucket name<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> s3 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> bucket policy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>S3 静态网站搭建</title>
      <link href="/2023/10/13/storage/s3/s3-jing-tai-wang-zhan-da-jian/"/>
      <url>/2023/10/13/storage/s3/s3-jing-tai-wang-zhan-da-jian/</url>
      
        <content type="html"><![CDATA[<p>S3 可以托管静态网站，格式是<a href="http://bucket-name.s3-website-region.amazonaws.com.cn/">bucket-name.s3-website-region.amazonaws.com.cn</a></p><p>访问网站下的对象：<a href="http://bucket-name.s3-website.region.amazonaws.com/object-name">http://bucket-name.s3-website.Region.amazonaws.com/object-name</a>)</p><p>需要设置的bucket policy</p><pre class="line-numbers language-json"><code class="language-json">&amp;#<span class="token number">123</span><span class="token punctuation">;</span>    <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>    <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        &amp;#<span class="token number">123</span><span class="token punctuation">;</span>            <span class="token property">"Sid"</span><span class="token operator">:</span> <span class="token string">"PublicReadGetObject"</span><span class="token punctuation">,</span>            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>            <span class="token property">"Principal"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token string">"s3:GetObject"</span><span class="token punctuation">,</span>            <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token string">"arn:aws-cn:s3:::bucket/**"</span><span class="token punctuation">,</span>            <span class="token property">"Condition"</span><span class="token operator">:</span> &amp;#<span class="token number">123</span><span class="token punctuation">;</span>                <span class="token property">"IpAddress"</span><span class="token operator">:</span> &amp;#<span class="token number">123</span><span class="token punctuation">;</span>                    <span class="token property">"aws:SourceIp"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                        <span class="token string">"ip1/32"</span><span class="token punctuation">,</span>                        <span class="token string">"ip2/32"</span>                    <span class="token punctuation">]</span>                &amp;#<span class="token number">125</span><span class="token punctuation">;</span>            &amp;#<span class="token number">125</span><span class="token punctuation">;</span>        &amp;#<span class="token number">125</span><span class="token punctuation">;</span>    <span class="token punctuation">]</span>&amp;#<span class="token number">125</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> s3 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> bucket policy </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
